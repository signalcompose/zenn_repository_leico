---
title: Midiを読み込むクラスを実装する
---


# 工事中

[前回のチャプター](./11) では、Midiファイルを読み込む時に必要な `MidiFileObjectFactoryModule` を作成しました。
このチャプターでは `MidiFileObjectFactoryModule` に `MidiFileObjectFactory` クラスを追加し、Midiファイルを読み込む機能を追加します。

## 機能の解説

このクラスの役割をまず解説します。
このクラスでは `.mid` や `.midi` というファイルをエディタに読み込む機能を提供します。
読み込む際、 uasset への変換を行う必要がありますが、 uasset への変換は `MidiFileObject` の方で行います。
受け取った midi ファイルを `MidiFileObject` へ渡し、処理された uasset を受け取りエディタに渡すといった、橋渡しの機能を行います。

## `MidiFileObjectFactory` クラスの作成

それでは早速この機能を作っていきます。まずは `MidiFileObjectFactoryModule` フォルダ内に `MidiFileObjectFactory` クラスを作成します。
クラスの基本的な作成方法は [Chapter 07](./07) で解説していますが、今回は以下のような設定が必要です。

### 1. 親クラスをFactory ( `UFactory` )にする

![親クラスをFactoryに変更する](/images/books/ue_midi_file_plugin/12/01.png)

ファイルを読み込み作成する機能へのインターフェイスはFactoryクラスが提供しているため、親クラスはFactoryを指定します。
`~~Factory~~` という別クラスが多いため注意してください。

### 2. privateクラスで、 `MidiFileObjectFactoryModule` モジュール内に作成する

![privateクラスで `MidiFileObjectFactoryModule` 内に作成する](/images/books/ue_midi_file_plugin/12/02.png)

private クラス(橙) にするのはエディタが自動的に呼び出す時以外使われないようにするためです。

## `MidiFileObjectFactory` クラスの編集

### `MidiFileObjectFactory.h` の編集

作られた2つのファイルの内、まずはヘッダファイルから編集を行います。
作られたばかりのヘッダファイルの内容はこのようになっているはずです。

```cpp
#pragma once

#include "CoreMinimal.h"
#include "Factories/Factory.h"
#include "MidiFileObjectFactory.generated.h"

/**
 * 
 */
UCLASS()
class UMidiFileObjectFactory : public UFactory
{
	GENERATED_BODY()
	
};
```

以下のように `public:` 以下に関数を2つ追加します。

```diff cpp
UCLASS()
class UMidiFileObjectFactory : public UFactory
{
	GENERATED_BODY()

+ public:
+	UMidiFileObjectFactory(const FObjectInitializer& ObjectInitializer);
+	
+	virtual UObject* FactoryCreateBinary(
+		UClass* InClass, UObject* InParent, FName InName, EObjectFlags Flags, UObject* Context,
+		const TCHAR* Type, const uint8*& Buffer, const uint8* BufferEnd, FFeedbackContext* Warn
+	) override;
+	
};
```

この2つの関数の実装は `MidiFileObjectFactory.cpp` で行います。
`UMidiFileObjectFactory` コンストラクタではMidiファイルの読み込みに関する基本情報をエディタに通達する処理を、
`FactoryCreateBinary` 関数では実際にバイナリファイルを読み込む処理を記述します。

### `MidiFileObjectFactory.cpp` の編集

`MidiFileObjectFactory.cpp` で2つの関数を実装します。
作られたばかりだと、このファイルはほとんど空っぽの状態になっています。

```cpp
#include "MidiFileObjectFactory.h"
```

以下のように関数を実装します。

```diff cpp

#include "MidiFileObjectFactory.h"
+ #include "MidiFileObject.h"
+ #include "MidiFile.h"
+ 
+ UMidiFileObjectFactory::UMidiFileObjectFactory(const FObjectInitializer& ObjectInitializer)
+ 	: Super(ObjectInitializer)
+ {
+ 	const FString description = NSLOCTEXT("UMidiFileObjectFactory", "MidiFileAsset", "Midi File").ToString();
+ 	Formats.Add( FString(TEXT("mid;" )) + description );
+ 	Formats.Add( FString(TEXT("midi;")) + description );
+ 
+ 	SupportedClass = UMidiFileObject::StaticClass();
+ 	
+ 	bCreateNew   = false;
+ 	bEditorImport = true;
+ }
+ 
+ UObject* UMidiFileObjectFactory :: FactoryCreateBinary(
+ 	UClass* InClass, UObject* InParent, FName InName, EObjectFlags Flags, UObject* Context,
+ 	const TCHAR* Type, const uint8*& Buffer, const uint8* BufferEnd, FFeedbackContext* Warn
+ )
+ {
+ 	UMidiFileObject* MidiFileObject = NewObject<UMidiFileObject>(InParent, InClass, InName, Flags);
+ 
+ 	if ( MidiFileObject -> includeBinary(Buffer, BufferEnd) )
+ 	{
+ 		return MidiFileObject;
+ 	}
+ 
+ 	return nullptr;
+ }
```


### `UMidiFileObjecFactory` コンストラクタの実装

```cpp
 	const FString description = NSLOCTEXT("UMidiFileObjectFactory", "MidiFileAsset", "Midi File").ToString();
 	Formats.Add( FString(TEXT("mid;" )) + description );
 	Formats.Add( FString(TEXT("midi;")) + description );
```

`Formats.Add` は対応する拡張子を指定します。拡張子にドット `.` は含みません。
指定方法は `[対応する拡張子]; 説明` という文字列を用います。
このプラグインで対応する拡張子は `mid` と `midi` のため、それぞれで設定をしています。
同じ説明を記述するのは冗長なため、 `description` という変数に説明文を入れて使いまわしています。

```cpp
 	SupportedClass = UMidiFileObject::StaticClass();
```

このファクトリクラスが作る、Midiファイルに対応したクラスを設定しています。

```cpp
 	bCreateNew   = false;
 	bEditorImport = true;
```

`bCreatedNew = false` でエディタ上での新規作成を禁止し、
`bEditorImport = true` でエディタへのインポートを許可しています。

### `FactoryCreateBinary` 関数の実装

この関数は、Factoryに関連するバイナリデータを受け取った際に実行されます。
今回の場合では `mid` や `midi` 拡張子のバイナリデータがインポートされた時にこの関数が実行されます。

```cpp
 	UMidiFileObject* MidiFileObject = NewObject<UMidiFileObject>(InParent, InClass, InName, Flags);
```

最初に作成したクラス、 `UMidiFileObject` を `NewObject` 関数を用いて作成します。

```cpp
 	if ( MidiFileObject -> includeBinary(Buffer, BufferEnd) )
 	{
 		return MidiFileObject;
 	}
```

まだ作成してませんが、 `MidiFileObject->includeBinary(start, end)` 関数でバイナリデータからMidiファイルを読み込みます。
読み込みが成功したら作成できた `MidiFileObject` を返します。

```cpp 
 	return nullptr;
```

失敗した場合は `nullptr` が返ります。また、 `MidiFileObject->includeBinary` 関数が失敗を通知します。
この時点での失敗はゲーム実行時ではなく編集時点で発生するため、読み込みエラーの通知だけにとどめています。