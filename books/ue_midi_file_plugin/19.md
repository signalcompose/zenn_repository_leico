---
title: 再生機能の実装:MidiEventクラスの作成
---

[前回のチャプター](./18) では、MIDIファイルから `MidiFileSequence` クラスインスタンスを作成する `CreateMidiFileSequence` ノードを実装しました。
このチャプターでは、再生処理に向けて `Sequence` ノードの出力で使用するイベントクラス `UMidiFilePluginMidiEvent` を作成します。

## `Sequence` ノードについて

以下は、MIDIファイルを再生し、出力を行う `Sequence` ノードのイメージです。

![Sequence](/images/books/ue_midi_file_plugin/19/01.png)

MIDIファイルは、1つのタイミングで複数のイベント（例：和音）を同時に発生させることがあります。  
そのため、`Sequence` ノードの出力は **複数のイベントを同時に返す配列型**に設計します。

### 配列出力のための型設計

Blueprintで配列を返すには、`TArray<Type>` 型を使用します。  
ただし、ここで指定する `Type` は Unreal Engine のリフレクション（UCLASS/Blueprint対応）に対応している必要があります。

そのため、MIDIイベント1件を表すクラス `UMidiFilePluginMidiEvent` を `UObject` から派生して新たに定義します。  
このクラスは内部的に `smf::MidiEvent` を保持し、Blueprint上ではそのラッパーとして扱います。

## `UMidiFilePluginMidiEvent` クラスを作成する

[Chapter 7](./07) で行ったように、Unreal Engine のクラス追加ウィザードを使って `MidiFileSequenceModule` に以下の条件で C++ クラスを追加します。

- 継承元   : `Object`  
- 公開設定 : `public`  
- 作成先   : `MidiFileSequenceModule`  
- クラス名 : `MidiFilePluginMidiEvent`
 
### 設定画面の例:

![継承元の設定](/images/books/ue_midi_file_plugin/19/02.png)
![公開設定、クラス名と作成先の設定](/images/books/ue_midi_file_plugin/19/03.png)

作成されるファイル:

![ファイルの確認](/images/books/ue_midi_file_plugin/19/04.png)


## クラスの実装

このクラスはデータ構造としてのみ使用するため、メンバ関数などは定義しません。

### `MidiFilePluginMidiEvent.h`

```cpp
// Copyright 2024 Signal compose Inc. All Rights Reserved.

#pragma once

#include "CoreMinimal.h"
#include "UObject/NoExportTypes.h"
#include "MidiEvent.h"
#include "MidiEventWrapper.generated.h"

/**
 * 
 */
UCLASS()
class MIDIFILESEQUENCEMODULE_API UMidiFilePluginMidiEvent : public UObject
{

public:
	GENERATED_BODY()

	smf :: MidiEvent event;
};
```

### `MidiFilePluginMidiEvent.cpp`

このクラスに関数などは作らないため、ファイルを削除して大丈夫です。


## ✅ まとめ

このチャプターでは、`Sequence` ノードの出力に使用する `UMidiFilePluginMidiEvent` クラスを作成しました。  
このクラスにより、複数のMIDIイベントを `TArray<UMidiFilePluginMidiEvent*>` として Blueprint 上で取り扱えるようになります。

次回は `Sequence` ノードの再生と停止を制御する `StartSequence` 、 `StopSequence` ノードを作成します。
