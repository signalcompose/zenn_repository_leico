---
title: MidiFileObjectにMIDIファイルを読み込む機能を作成する
---

[前回のチャプター](./12)では、`MidiFileObjectFactory` クラスでMIDIファイルを読み込み、`MidiFileObject` を生成する処理を実装しました。  
このチャプターでは、`MidiFileObject` に `includeBinary` 関数を実装し、MIDIファイルの内容を実際に読み込む処理を行います。

## 処理の流れと実装方針

まず、`MidiFileObjectFactory::FactoryCreateBinary` の引数を確認します。

```cpp
UObject* UMidiFileObjectFactory::FactoryCreateBinary(..., const uint8*& Buffer, const uint8* BufferEnd, ...)
```

ここから、MIDIファイルのデータは `Buffer`（データの始点）と `BufferEnd`（終点）として受け取れることがわかります。  
まずはこの2つを `includeBinary(const uint8*& Start, const uint8* End)` のように受け取り、内部でデータを保持することとします。

```cpp
const int32 datasize = end - start;
TArray<uint8> data;
data.Reserve(datasize);
data.Append (start, datasize);
```

この `TArray<uint8>` 型から、 `MidiFile` が読み取れる形式に変換します。

### MIDIファイルの読み込みに必要な変換

`includeBinary` 関数では、外部ライブラリ `MidiFile` の機能を用いてMIDIデータを読み込みます。  
`MidiFile` は `std::istream` からデータを読み込む機能を提供しています:

https://github.com/craigsapp/midifile/blob/98917df5b1bf0d6e8d4c0e5fff86d6b05343e793/src/MidiFile.cpp#L94

つまり、`TArray<uint8>` から `std::istream` に変換できれば、MIDIデータの読み込みが可能になります。

### `TArray<uint8>` から `std::istream` への変換

`std::istream` をメモリ上のバッファから読み込ませるには、`std::streambuf` を継承したクラスを用いるのが一般的です。  
以下は Stack Overflow で紹介されている実装例です:


```cpp
struct membuf : std::streambuf
{
    membuf(char* begin, char* end) {
        this->setg(begin, begin, end);
    }
};

int main()
{
    char buffer[] = "I'm a buffer with embedded nulls\0and line\n feeds";

    membuf sbuf(buffer, buffer + sizeof(buffer));
    std::istream in(&sbuf);
    ...
}
```

> https://stackoverflow.com/a/7782037

これを応用して、`TArray<uint8>` を `std::istream` に渡すバッファクラスを作成します。

```cpp
struct inputBuffer : public std::streambuf
{
    explicit inputBuffer(TArray<uint8>& data) {
		char *begin = reinterpret_cast<char*>( data.GetData() );
		char *end   = begin + data.Num();
        this->setg(begin, begin, end);
    }
};
```


### まとめ:変換手順の流れ

| ステップ       | 内容                                                |
|----------------|-----------------------------------------------------|
| 元データ       | `const uint8* Buffer`, `const uint8* BufferEnd`     |
| データの保持   | `TArray<uint8>` にコピー                            |
| ストリーム化   | `inputBuffer` 経由で `std::istream` を作成          |
| 読み込み処理   | `MidiFile.read(std::istream&)` で読み込み           |

## MidiFileObject.h の変更

```cpp
UCLASS()
class MIDIFILEPLUGIN_API UMidiFileObject : public UObject
{
public:
	GENERATED_BODY()

	const bool includeBinary(const uint8*& start, const uint8* end);

private:

	smf :: MidiFile _midi;
	
};
```

- `includeBinary(const uint8*& start, const uint8* end)`  
  外部から呼び出す関数で、MIDIファイルのバイナリデータを `_midi` に読み込みます。

- `_midi`  
  パースされたMIDIデータ本体。外部からは使用されないため `private` としています。


## `MidiFileObject.cpp` の変更

以下が実装コードです。

```cpp
#include "MidiFileObject.h" //最初にインクルードしないとエラー
#include <streambuf>
#include <iostream>


struct inputBuffer : public std::streambuf
{
    explicit inputBuffer(TArray<uint8>& data) {
		char *begin = reinterpret_cast<char*>( data.GetData() );
		char *end   = begin + data.Num();
        this->setg(begin, begin, end);
    }
};

const bool UMidiFileObject :: includeBinary(const uint8*& start, const uint8* end){

	const int32 datasize = end - start;
	TArray<uint8> data;                      // 1
	data.Reserve(       datasize);
	data.Append (start, datasize);

	UE_LOG(LogTemp, Verbose, TEXT("data.Num : %d"), data.Num());

	inputBuffer inputbuf(data);             // 2
	std :: istream datastream(&inputbuf);

	if(_midi.read(datastream)){             // 3
	    _midi.joinTracks    ();
		_midi.sortTracks    ();
		_midi.linkNotePairs ();
		_midi.doTimeAnalysis();
		UE_LOG(LogTemp, Verbose, TEXT("Load Success"));

		return true;
	}
	UE_LOG(LogTemp, Warning, TEXT("Load Failed"));

	return false;

}
```

## 解説：読み込みの各ステップ

1. `TArray<uint8> data; ...`
  * `start` ～ `end` のバイナリデータをローカル配列にコピーします
2. `inputBuffer inputbuf(data); ...`
  * MidiFileが読めるように `std::istream` を作成しています
3. `if(_midi.read(datastream)){...`
  * データを `MidiFile` へ読み込み、トラックの統合や時間解析などを行います

## 次のチャプターへ

読み込み処理は完成しましたが、現時点ではまだビルドに失敗します。  
次のチャプターでは、必要なモジュールパスの設定について説明します。→ [Chapter 14](./14)