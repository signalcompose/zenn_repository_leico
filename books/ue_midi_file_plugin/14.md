---
title: MidiFileObjectFactoryModuleのパス設定
---

[前回のチャプター](./13)では、`MidiFileObject` 側でMIDIファイルを読み込む実装を行いました。  
しかし、まだビルドが正常に通らない状態です。

![正常に書いてもビルドに失敗する](/images/books/ue_midi_file_plugin/14/01.png)

このチャプターでは、ビルドエラーを解消するために必要なモジュールのパス設定を行います。

## パスの設定について

Unreal Engine では、各モジュールごとに依存パスやモジュールの参照設定を行う必要があります。  
これらの設定は `[モジュール名]/[モジュール名].Build.cs` ファイルに記述します。

簡単な設定については [Chapter 08](./08) で触れましたが、今回の `MidiFileObjectFactoryModule` では次の3点の設定が必要です：

1. `MidiFileObject.h` を読み込むためのインクルードパスの追加  
2. `MidiFilePlugin` モジュールの依存関係の追加
3. Unreal Engineエディタ拡張用のモジュールの追加


## `MidiFileObjectFactoryModule.Build.cs` の設定

以下のように、必要なパスや依存モジュールを `Build.cs` に追加します。

```cs
public class MidiFileObjectFactoryModule : ModuleRules
{
	public MidiFileObjectFactoryModule(ReadOnlyTargetRules Target) : base(Target)
	{
		PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;
		
		PublicIncludePaths.AddRange(
			new string[] {
				// ... add public include paths required here ...
				"$(PluginDir)/Source/MidiFilePlugin/Public" //追加
			}
			);
				
		
		PrivateIncludePaths.AddRange(
			new string[] {
				// ... add other private include paths required here ...
			}
			);
			
		
		PublicDependencyModuleNames.AddRange(
			new string[]
			{
				"Core",
				"MidiFile",

				// ... add other public dependencies that you statically link with here ...
				"MidiFilePlugin", //追加
			}
			);
			
		
		PrivateDependencyModuleNames.AddRange(
			new string[]
			{
				"CoreUObject",
				"Engine",
				"Slate",
				"SlateCore",
				// ... add private dependencies that you statically link with here ...	
				"UnrealEd" //追加
			}
			);
		
		
		DynamicallyLoadedModuleNames.AddRange(
			new string[]
			{
				// ... add any modules that your module loads dynamically here ...
			}
			);
	}
}
```

## 各設定項目の解説

### `PublicIncludePaths`

```cs
PublicIncludePaths.AddRange( new string[] {
	"$(PluginDir)/Source/MidiFilePlugin/Public"
});
```

`MidiFileObject.h` が含まれているディレクトリを指定します。
`$(PluginDir)` は、このモジュール(MidiFileObjectFactoryModule)が属するプラグインディレクトリのルートパスに自動的に置き換えられます。

### `PublicDependencyModuleNames`

```cs
PublicDependencyModuleNames.AddRange( new string[] {
    ...
	"MidiFilePlugin",
});
```

ヘッダファイルを参照するだけでは、実装はリンクされず引き続きビルドエラーになります。
ここで `MidiFilePlugin` を依存モジュールとして明示的に指定する必要があります。

### `PrivateDependencyModuleNames`

```cs
PrivateDependencyModuleNames.AddRange( new string[] {
    ...
	"UnrealEd"
});

```
Unreal Engine のエディタ拡張機能を使うためには、`UnrealEd` モジュールの依存追加が必要です。

これらの設定を行うことでようやくビルドが通るようになります。

![ビルドが成功 in Visual Studio](/images/books/ue_midi_file_plugin/14/02.gif)

ビルドが通ると、Unreal EngineにMidiファイルをインポートすることができるようになります。

![Midiファイルのインポート](/images/books/ue_midi_file_plugin/14/03.gif)

`Log LogTemp Verbose` をUnreal Engineのエディタで行うと、インポート成功時のログが見えるようになります。

```
Cmd: Log LogTemp Verbose
...
LogTemp: Verbose: data.Num : 33977
LogTemp: Verbose: Load Success
```

[次のチャプター](./15)では、`MidiFileObject` にMidiをuassetとして保存する機能を実装します。