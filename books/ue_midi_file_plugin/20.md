---
title: 再生機能の実装:StartSequenceとStopSequence
---

[前回のチャプター](./19) では、 `Sequence` ノードの出力で利用する `UMidiFilePluginMidiEvent` クラスを作成しました。
このチャプターでは、 `StartSequence` 、 `StopSequence` とシーケンスの制御を行う2つのBlueprintノードを作成します。

## このチャプターで作成する機能

主に以下の機能と関数を追加します：

1. `Start Sequence`  
   MIDIシーケンスの再生を開始します  
   ![Start Sequence](/images/books/ue_midi_file_plugin/20/01.png)
2. `Stop Sequence`  
   再生中のシーケンスを停止します  
   ![Stop Sequence](/images/books/ue_midi_file_plugin/20/02.png)
3. `SetMidiFileObject` 関数  
   `MidiFileSequence` に担当するMIDIファイルデータを関連付けます。



## `StartSequence` ノードの実装

`StartSequence` は、再生中かどうかを示すフラグ `bProgress` を `true` に設定します。

### `MidiFileSequence.h`

```diff cpp

#include "CoreMinimal.h"
#include "UObject/NoExportTypes.h"
#include "MidiFileSequence.generated.h"

/**
 * 
 */
UCLASS()
class MIDIFILESEQUENCEMODULE_API UMidiFileSequence : public UObject
{
+ public:
	GENERATED_BODY()

+	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
+	void StartSequence(const double offset);

+ private:
+ 	bool bProgress;
	
};

```

### `MidiFileSequence.cpp`

```diff cpp
#include "MidiFileSequence.h"

+ void UMidiFileSequence :: StartSequence(const double offset){
+     
+     if(bProgress == true)
+         return;
+ 
+     bProgress = true;
+ }
```


## コンストラクタの実装

メンバ変数 `bProgress` ができたので、コンストラクタを作成して `bProgress` を初期化します。

### `MidiFileSequence.h`

```diff cpp
UCLASS()
class MIDIFILESEQUENCEMODULE_API UMidiFileSequence : public UObject
{
public:
	GENERATED_BODY()

+	UMidiFileSequence();

	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
	void StartSequence(const double offset);

private:
	bool bProgress;
	
};

```

### `MidiFileSequence.cpp`

```diff cpp

#include "MidiFileSequence.h"

+ UMidiFileSequence :: UMidiFileSequence(void) : 
+       Super()
+     , bProgress(false)
+ {}

  void UMidiFileSequence :: StartSequence(const double offset){...}

```

## `StopSequence` ノードの実装

再生を停止する関数です。`bProgress` を `false` にリセットします。

### `MidiFileSequence.h`

```diff cpp
UCLASS()
class MIDIFILESEQUENCEMODULE_API UMidiFileSequence : public UObject
{
public:
	GENERATED_BODY()

	UMidiFileSequence();

	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
	void StartSequence(const double offset);

+	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
+	void StopSequence();

private:
	bool bProgress;
	
};

```

### `MidiFileSequence.cpp`

```diff cpp
#include "MidiFileSequence.h"

UMidiFileSequence :: UMidiFileSequence(void) : ... {}

void UMidiFileSequence :: StartSequence(const double offset){ ... }

+ void UMidiFileSequence :: StopSequence(void) {
+     bProgress = false;
+ }
```

## `SetMidiFileObject` 関数の実装


このチャプターの最後に、 [チャプター18](./18) でコメントアウトしていた `SetMidiFileObject` 関数を実装します。
`UMidiFileObject` を内部に保持し、再生時に参照できるようにします。

`SetMidiFileObject` の実装に伴い、コンストラクタと `StartSequence` 関数に `SetMidiFileObject` 用のコードを追加しています。


### `MidiFileSequence.h`

```diff cpp
UCLASS()
class MIDIFILESEQUENCEMODULE_API UMidiFileSequence : public UObject
{
public:
	GENERATED_BODY()

	UMidiFileSequence();

+	void SetMidiFileObject(UMidiFileObject* MidiFileObject);

	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
	void StartSequence(const double offset);

	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
	void StopSequence();

private:
+	UMidiFileObject* _midiFileObject;
	bool bProgress;
	
};
```

### `MidiFileSequence.cpp`

```diff cpp

#include "MidiFileSequence.h"

UMidiFileSequence :: UMidiFileSequence(void) : 
      Super()
+   , _midiFileObject(nullptr)
    , bProgress(false)
{}

+ void UMidiFileSequence :: SetMidiFileObject(UMidiFileObject* MidiFileObject){
+     
+     _midiFileObject = MidiFileObject;
+ }

void UMidiFileSequence :: StartSequence(const double offset){
    
+    if(_midiFileObject == nullptr) {
+		UE_LOG(LogTemp, Error, TEXT("[UMidiFileSequence :: StartSequence] : _midiFileObject == nullptr"));
+        return;
+    }

    if(bProgress == true)
        return;

    bProgress = true;
}

void UMidiFileSequence :: StopSequence(void) {...}
```

### `MidiFilePluginBlueprint.cpp` で `SetMidiFileObject` 呼び出しの有効化

```diff cpp
UMidiFileSequence* UMidiFilePluginBlueprint :: CreateMidiFileSequence(UMidiFileObject* MidiFileObject){

    if( ! ensureMsgf(MidiFileObject != nullptr, TEXT("[UMidiFileObjectBlueprint :: CreateMidiFileSequence] : MidiFileObject is nullptr")) )
        return nullptr;

    UMidiFileSequence* MidiFileSequence = NewObject<UMidiFileSequence>();

+   MidiFileSequence -> SetMidiFileObject(MidiFileObject); 
    
    return MidiFileSequence;
}
```


## まとめ

ここまでの実装により、`Start Sequence` と `Stop Sequence` ノードが Blueprint 上で使用可能になります。  
ただし、現時点では MIDI の再生処理自体は未実装です。  
次のチャプターでは、再生処理の中核となる `Sequence` ノードの実装を進めていきます。

![StartSequence / StopeSequence ノード](/images/books/ue_midi_file_plugin/20/03.gif)

