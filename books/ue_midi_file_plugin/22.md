---
title : MIDIイベント処理:MIDIイベントの判別を行う
---

[前回のチャプター](./21) では、MIDIファイルの再生とMIDIイベントの出力を行う `Sequence` ノードを実装しました。
このチャプターではMIDIイベントの種類(ノートオン、ノートオフ、コントロールチェンジ、etc...)に応じて実行経路を分岐する `BranchMidiEvent` ノードを作成します。

## `BranchMidiEvent` ノードの概要

![BranchMidiEvent](/images/books/ue_midi_file_plugin/22/01.png)

- 1つの MIDI イベントを受け取り、そのイベントの種類を判定します。
- 判定結果に応じて、異なる実行ピンを通じてイベントと実行フローを分岐させます。

## 複数の実行ビンを持つノードの作成方法

`BranchMidiEvent` のように、複数の実行ピン（Exec）を持つBlueprintノードを作成するには、以下の手順を踏みます：

1. 実行ピンの種類を `enum` 型で定義する。
2. 対象関数の引数に `enum` **参照型** 引数を追加する
3. `UFUNCTION` マクロに `meta = (ExpandEnumAsExecs = "引数名")` を指定する

参考:

- [Execution Pins](https://dev.epicgames.com/community/learning/tutorials/Klde/unreal-engine-custom-blueprint-nodes-exposing-c-to-blueprint-with-ufunction#7executionpins)

## UMidiFilePluginBlueprint クラスの更新


### `MidiFilePluginBlueprint.h`

```diff cpp
  #pragma once
  
  #include "CoreMinimal.h"
  #include "Kismet/BlueprintFunctionLibrary.h"
  #include "MidiFileObject.h"
  #include "MidiFileSequence.h"
+ #include "MidiFilePluginMidiEvent.h"
  #include "MidiFilePluginBlueprint.generated.h"

+ UENUM(BlueprintType)
+ enum class EMidiType : uint8 {
+ 	NOTE_OFF,
+ 	NOTE_ON,
+ 	CC,
+ 	OTHER
+ };

  /**
   * 
   */
  UCLASS()
  class MIDIFILEPLUGINBLUEPRINTMODULE_API UMidiFilePluginBlueprint : public UBlueprintFunctionLibrary
  {
  	GENERATED_BODY()
  
  public:
  	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
  	static UMidiFileSequence* CreateMidiFileSequence(UMidiFileObject* MidiFileObject);
  
+  	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin", meta = (ExpandEnumAsExecs = "MidiType"))
+  	static UMidiFilePluginMidiEvent* BranchMidiEvent(UMidiFilePluginMidiEvent* mfp_event, EMidiType& MidiType);
  };
```

### `MidiFilePluginBlueprint.cpp`

```diff cpp
...

+ UMidiFilePluginMidiEvent* UMidiFilePluginBlueprint :: BranchMidiEvent(UMidiFilePluginMidiEvent* mfp_event, EMidiType& MidiType){
+ 
+     if( ! ensureMsgf(mfp_event != nullptr, TEXT("[UMidiFilePluginBlueprint :: BranchMidiEvent] : mfp_event is nullptr")) )
+         return nullptr;
+ 
+     const smf :: MidiEvent& midi_event = mfp_event -> event;
+ 
+     MidiType = midi_event.isNoteOff   () ? EMidiType :: NOTE_OFF :
+                midi_event.isNoteOn    () ? EMidiType :: NOTE_ON  :
+                midi_event.isController() ? EMidiType :: CC       :
+                                            EMidiType :: OTHER;
+     return mfp_event;
+ }

```

## 判別できる MIDI イベントの種類

この実装では、以下の4種類のMIDIイベントを判別しています:


- ノートオフ( `NOTE OFF` )
- ノートオン( `NOTE ON` )
- コントロールチェンジ( `CC` )
- 上記以外( `OTHER` )

必要に応じて、ピッチベンドなど他のMIDIイベントを `EMidiType` に追加して分岐を増やすことができます。

## Blueprint の更新

以下のように、 `Sequence` ノードの後にノードを追加します。

![BranchMidiEventノードの追加](/images/books/ue_midi_file_plugin/22/02.png)

![Note Off ピンの実行確認](/images/books/ue_midi_file_plugin/22/03.gif)

## まとめ

このチャプターでは、MIDIイベントの種類に応じて実行経路を分岐できる `BranchMidiEvent` ノードを実装しました。  
このノードによって、イベントの種類ごとに異なる処理を実行するBlueprintの実装が可能になります。

次のチャプターでは、実際に各種MIDIイベント(Note On/Off など)を処理するノードを実装していきます。
