---
title: MidiFilePluginBlueprintModuleとMidiFileSequenceModuleを作成する
---

[前回のチャプター](./16) では、BlueprintノードとC++クラス関数の関係や、
Blueprint上でインスタンスを扱う上での注意、主にガベージコレクションに関する問題をまとめました。

このチャプターでは、Blueprintノード用のクラスを実装する2つのモジュールを作成します。

## モジュールの作成方法のおさらい

Unreal Engineにおけるモジュールに関する情報は [チャプター10](./10) で、
また、実際にモジュールを作成する作業は [チャプター11](./11) で行いました。
今回もその手順をベースに、`MidiFileObjectFactoryModule` のビルド設定などを流用しながら進めます。

## `MidiFilePluginBlueprintModule` の作成 

1. `MidiFileObjectFactoryModule` フォルダをコピーし、 `MidiFilePluginBlueprintModule` という名前に変更します
2. コピー先モジュールないで、 `Public/MidiFileObjectFactoryModule.h` と `Private/MidiFileObjectFactoryModule.cpp` 以外のファイルを削除します
3. ファイル名を以下のように変更します
   - `MidiFileObjectFactoryModule.Build.cs` -> `MidiFilePluginBlueprintModule.Build.cs`
   - `MidiFileObjectFactoryModule.h`        -> `MidiFilePluginBlueprintModule.h`
   - `MidiFileObjectFactoryModule.cpp`      -> `MidiFilePluginBlueprintModule.cpp`
4. 各ファイルの中身を、以下のように更新します

### `MidiFilePluginBlueprintModule.Build.cs`

```diff cs
using UnrealBuildTool;

+ public class MidiFilePluginBlueprintModule : ModuleRules //クラス名変更
{
+ 	public MidiFilePluginBlueprintModule(ReadOnlyTargetRules Target) : base(Target) //コンストラクタ名変更
	{
		PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;

		PublicIncludePaths.AddRange(
			new string[] {
				// ... add public include paths required here ...
				"$(PluginDir)/Source/MidiFilePlugin/Public"
			}
			);
		PrivateIncludePaths.AddRange(
			new string[] {
				// ... add other private include paths required here ...
			}
			);
		PublicDependencyModuleNames.AddRange(
			new string[]
			{
				"Core",
				"MidiFile",

				"MidiFilePlugin",
				// ... add other public dependencies that you statically link with here ...
			}
			);
		PrivateDependencyModuleNames.AddRange(
			new string[]
			{
				"CoreUObject",
				"Engine",
				"Slate",
				"SlateCore",
-				"UnrealEd" //削除
				// ... add private dependencies that you statically link with here ...	
			}
			);
		DynamicallyLoadedModuleNames.AddRange(
			new string[]
			{
				// ... add any modules that your module loads dynamically here ...
			}
			);
	}
}
```

### `MidiFilePluginBlueprintModule.h`

```diff cpp
#pragma once

#include "Modules/ModuleManager.h"

+ class FMidiFilePluginBlueprintModule : public IModuleInterface //クラス名変更
{
public:

	/** IModuleInterface implementation */
	virtual void StartupModule() override;
	virtual void ShutdownModule() override;
};
```

### `MidiFilePluginBlueprintModule.cpp`

```diff cpp
+ #include "MidiFilePluginBlueprintModule.h" //ファイル名変更

+ #define LOCTEXT_NAMESPACE "FMidiFilePluginBlueprintModule" //文字列変更

+ void FMidiFilePluginBlueprintModule::StartupModule() //クラス名変更
{
	// This code will execute after your module is loaded into memory; the exact timing is specified in the .uplugin file per-module
}

+ void FMidiFilePluginBlueprintModule::ShutdownModule() //クラス名変更
{
	// This function may be called during shutdown to clean up your module.  For modules that support dynamic reloading,
	// we call this function before unloading the module.
}

#undef LOCTEXT_NAMESPACE
	
+ IMPLEMENT_MODULE(FMidiFilePluginBlueprintModule, MidiFilePluginBlueprintModule) // 変数2つとも名称変更
```

### `MidiFilePlugin.uplugin`

今作成したモジュールがコンパイルされるように、プラグインの設定ファイルにもモジュールを登録します。

```diff json
{
  "FileVersion": 3,
  "Version": 1,
  "VersionName": "1.0",
  "Modules": [
    {
      "Name": "MidiFilePlugin",
      "Type": "Runtime",
      "LoadingPhase": "Default"
    },
    {
      "Name": "MidiFileObjectFactoryModule",
      "Type": "Editor",
      "LoadingPhase": "Default"
+    }, // コンマ追加
+    {
+      "Name": "MidiFilePluginBlueprintModule",
+      "Type": "Runtime",
+      "LoadingPhase": "Default"
+    }
  ],
  "FriendlyName": "MidiFilePlugin",
  "Description": "",
  "Category": "Other",
  "CreatedBy": "",
  "CreatedByURL": "",
  "DocsURL": "",
  "MarketplaceURL": "",
  "SupportURL": "",
  "CanContainContent": "true",
  "Installed": false,
  "IsBetaVersion": false,
  "Plugins": [],
  "SupportedTargetPlatforms": null
}
```

ここまでの修正を行い、ビルドが通るか一度確認します。

## `MidiFileSequenceModule` の作成

次に、同様の手順で `MidiFileSequenceModule` を作成します。

1. `MidiFilePluginBlueprintModule` フォルダをコピーし、 `MidiFileSequenceModule` という名前に変更します
3. コピー先モジュール内のファイル名を以下のように変更します
   1. `MidiFilePluginBlueprintModule.Build.cs` -> `MidiFileSequenceModule.Build.cs`
   2. `MidiFilePluginBlueprintModule.h`        -> `MidiFileSequenceModule.h`
   3. `MidiFilePluginBlueprintModule.cpp`      -> `MidiFileSequenceModule.cpp`
4. 各ファイルの中身を、以下のように変更します

### `MidiFileSequenceModule.Build.cs`

```diff cs
using UnrealBuildTool;

+ public class MidiFileSequenceModule : ModuleRules // クラス名変更
{
+	public MidiFileSequenceModule(ReadOnlyTargetRules Target) : base(Target) //コンストラクタ名変更
	{
		PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;
		
		PublicIncludePaths.AddRange(
			new string[] {
				// ... add public include paths required here ...
				"$(PluginDir)/Source/MidiFilePlugin/Public"
			}
		);
		PrivateIncludePaths.AddRange(
			new string[] {
				// ... add other private include paths required here ...
			}
		);
		PublicDependencyModuleNames.AddRange(
			new string[]
			{
				"Core",
				"MidiFile",
				"MidiFilePlugin",
				// ... add other public dependencies that you statically link with here ...
			}
		);
		PrivateDependencyModuleNames.AddRange(
			new string[]
			{
				"CoreUObject",
				"Engine",
				"Slate",
				"SlateCore"
				// ... add private dependencies that you statically link with here ...	
			}
		);
		DynamicallyLoadedModuleNames.AddRange(
			new string[]
			{
				// ... add any modules that your module loads dynamically here ...
			}
			);
	}
}
```

### `MidiFileSequenceModule.h`

```diff cpp
#pragma once

#include "Modules/ModuleManager.h"

+ class FMidiFileSequenceModule : public IModuleInterface //クラス名変更
{
public:

	/** IModuleInterface implementation */
	virtual void StartupModule() override;
	virtual void ShutdownModule() override;
};

```

### `MidiFileSequenceModule.cpp`

```diff cpp
+ #include "MidiFileSequenceModule.h" // ファイル名変更

+ #define LOCTEXT_NAMESPACE "FMidiFileSequenceModule" // 文字列変更

+ void FMidiFileSequenceModule::StartupModule() // クラス名変更
{
	// This code will execute after your module is loaded into memory; the exact timing is specified in the .uplugin file per-module
}

+ void FMidiFileSequenceModule::ShutdownModule() // クラス名変更
{
	// This function may be called during shutdown to clean up your module.  For modules that support dynamic reloading,
	// we call this function before unloading the module.
}

#undef LOCTEXT_NAMESPACE

+ IMPLEMENT_MODULE(FMidiFileSequenceModule, MidiFileSequenceModule) // 変数名2つ変更
```

### `MidiFilePlugin.uplugin`

こちらでもモジュールがコンパイルされるように、プラグインの設定ファイルにモジュールを登録します。

```diff json
{
  "FileVersion": 3,
  "Version": 1,
  "VersionName": "1.0",
  "Modules": [
    {
      "Name": "MidiFilePlugin",
      "Type": "Runtime",
      "LoadingPhase": "Default"
    },
    {
      "Name": "MidiFileObjectFactoryModule",
      "Type": "Editor",
      "LoadingPhase": "Default"
    },
    {
      "Name": "MidiFilePluginBlueprintModule",
      "Type": "Runtime",
      "LoadingPhase": "Default"
+    }, //コンマ追加
+    {
+      "Name": "MidiFileSequenceModule",
+      "Type": "Runtime",
+      "LoadingPhase": "Default"
+    }

  ],
  "FriendlyName": "MidiFilePlugin",
  "Description": "",
  "Category": "Other",
  "CreatedBy": "",
  "CreatedByURL": "",
  "DocsURL": "",
  "MarketplaceURL": "",
  "SupportURL": "",
  "CanContainContent": "true",
  "Installed": false,
  "IsBetaVersion": false,
  "Plugins": [],
  "SupportedTargetPlatforms": null
}
```

再び、ビルドが通るか確認します。
ビルドが通ったら、いよいよ次回からBlueprintノードを作成します。