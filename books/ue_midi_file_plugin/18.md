---
title: MidiFileからMidiFileSequenceを作成するCreateMidiFileSequenceノードを作成する
---

[前回のチャプター](./17) では、Blueprintノードを実装するためのモジュールを2つ作成しました。  
このチャプターからは、それぞれのモジュールに C++ ファイルを追加し、Blueprintノードの実装を進めていきます。

## このチャプターで作成するBlueprintノード


このチャプターではまず、`CreateMidiFileSequence` というノードを作成します。  
このノードは、インポートしたMIDIファイルから `MidiFileSequence` のインスタンスを生成する機能を持ちます。

![CreateMidiFileSequence](/images/books/ue_midi_file_plugin/18/01.png)

## C++クラスを作成する

[Chapter 7](./07) と同様に、Unreal Engine エディタから C++ クラスを追加します。  
今回は2つのモジュールに、それぞれ1クラスずつ追加します。


### `MidiFilePluginBlueprintModule` に `MidiFilePluginBlueprint` クラスを作成

* 継承元   : `BlueprintFunctionLibrary`
* 公開設定 : `public`
* 作成先   : `MidiFilePluginBlueprintModule`
* クラス名 : `MidiFilePluginBlueprint`
 
設定画面の例:

![継承元の設定](/images/books/ue_midi_file_plugin/18/02.png)
![公開設定、クラス名と作成先の設定](/images/books/ue_midi_file_plugin/18/03.png)

作成されるファイル:

![ファイルの確認](/images/books/ue_midi_file_plugin/18/04.png)

### `MidiFileSequenceModule` に `MidiFileSequence` クラスを作成

* 継承元   : `Object`
* 公開設定 : `public`
* 作成先   : `MidiFileSequenceModule`
* クラス名 : `MidiFileSequence`

設定画面の例:

![継承元の設定](/images/books/ue_midi_file_plugin/18/05.png)
![公開設定、クラス名と作成先の設定](/images/books/ue_midi_file_plugin/18/06.png)

作成されるファイル:

![ファイルの確認](/images/books/ue_midi_file_plugin/18/07.png)

## `MidiFilePluginBlueprintModule` のビルド設定を変更

`MidiFilePluginBlueprintModule.Build.cs` に `MidiFileSequenceModule` を依存モジュールとして追加します。

```diff cs
// ...省略
		PublicIncludePaths.AddRange(
			new string[] {
				// ... add public include paths required here ...
				"$(PluginDir)/Source/MidiFileAsset/Public",
+				"$(PluginDir)/Source/MidiFileSequenceModule/Public", // 追加
            }
			);
				
// ...省略		
		
		PublicDependencyModuleNames.AddRange(
			new string[]
			{
				"Core",
				"MidiFile",

				"MidiFileAsset",
+				"MidiFileSequenceModule", //追加
				// ... add other public dependencies that you statically link with here ...
			}
			);
// ...省略	
```

## Blueprintノードの実装

### `MidiFilePluginBlueprint.h` 

```diff cpp
#pragma once

#include "CoreMinimal.h"
#include "Kismet/BlueprintFunctionLibrary.h"
+ #include "MidiFileObject.h"   //追加
+ #include "MidiFileSequence.h" //追加
#include "MidiFilePluginBlueprint.generated.h"


/**
 * 
 */
UCLASS()
class MIDIFILEPLUGINBLUEPRINTMODULE_API UMidiFilePluginBlueprint : public UBlueprintFunctionLibrary
{
	GENERATED_BODY()

+ public:
+ 	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
+ 	static UMidiFileSequence* CreateMidiFileSequence(UMidiFileObject* MidiFileObject);
};
```

- `UFUNCTION` は、関数を Blueprint からアクセス可能にするためのマクロです
  - `BlueprintCallable` を指定することで、Blueprint ノードとしてこの関数が利用できるようになります
  - `Category` は Blueprint 上でノードを分類するためのラベルです
- `static` を指定することで、インスタンスを介さず直接呼び出せる関数になります
  - `UBlueprintFunctionLibrary` の関数は基本的に `static` として定義されます

### `MidiFilePluginBlueprint.cpp`

```diff cpp
#include "MidiFilePluginBlueprint.h"

+ UMidiFileSequence* UMidiFilePluginBlueprint :: CreateMidiFileSequence(UMidiFileObject* MidiFileObject){
+ 
+     if( ! ensureMsgf(MidiFileObject != nullptr, TEXT("[UMidiFileObjectBlueprint :: CreateMidiFileSequence] : MidiFileObject is nullptr")) )
+         return nullptr;
+ 
+     UMidiFileSequence* MidiFileSequence = NewObject<UMidiFileSequence>();
+ 
+     // MidiFileSequence -> SetMidiFileObject(MidiFileObject); //まだ実装していないのでコメントアウト
+     
+     return MidiFileSequence;
+ }
```

- `ensureMsgf` の `if` は `nullptr` チェックのための安全マクロで、失敗時には警告ログを出力して実行を一時停止させます
- `NewObject<T>()` を使用して `UMidiFileSequence` のインスタンスを生成しています


## 動作確認

ビルドを行い、Blueprint エディタ上で `CreateMidiFileSequence` ノードが使用可能になっているか確認します。

![CreateMidiFileSequenceノード](/images/books/ue_midi_file_plugin/18/08.gif)
