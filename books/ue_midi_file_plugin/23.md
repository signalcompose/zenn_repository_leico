---
title : MIDIイベント処理:ノートオン/オフとコントロールチェンジ用ノードの作成
---

[前回のチャプター](./22) では、MIDIイベントの種類に応じて実行経路を分岐する `BranchMidiEvent` ノードを作成しました。
このチャプターでは、ノートオン／ノートオフ、コントロールチェンジ（Control Change）イベントを処理する以下の2つのノードを実装します：

- `ParseMidiEvent`
- `ParseCC`

## `ParseMidiEvent` ノードの概要

![ParseMidiEvent](/images/books/ue_midi_file_plugin/23/01.png)

このノードは、1つの MIDI イベントから以下の情報を `int` 型で取得して出力します:

- チャンネル( `Ch` )
- ノートナンバー( `Note` )
- ベロシティ( `Velocity` )

対象となるイベントはノートオン／ノートオフです。

## `ParseCC` ノードの概要

![ParseCC](/images/books/ue_midi_file_plugin/23/02.png)

このノードは、MIDI のコントロールチェンジ ( CC ) イベントから以下の情報を抽出します:

- チャンネル( `Ch` )
- コントロールナンバー( `No` )
- 設定値( `Value` )


## 複数のデータを出力する Blueprint ノードの作成方法

通常の C++ 関数では戻り値は 1 つだけですが、Blueprint ノードでは複数の値を同時に出力することが可能です。
複数の出力を実現するには、関数の引数として **非 const の参照型** (例: `int&`) を使います。  
Blueprint はこの参照型を「出力ピン」として自動的に解釈し、ノード上に表示してくれます。

```cpp
UFUNCTION(BlueprintCallable)
static void ParseMidiEvent(UMidiFilePluginMidiEvent* mfp_event, int& ch, int& note, int& velocity);
```

上記のように定義すると、 `mfp_event` を入力として受け取り、 `ch` 、`note` 、`velocity` の 3 つの出力ピンを持つノードが生成されます。

参考:

- [Parameters](https://dev.epicgames.com/community/learning/tutorials/Klde/unreal-engine-custom-blueprint-nodes-exposing-c-to-blueprint-with-ufunction#2parameters(basics))

## `UMidiFilePluginBlueprint` クラスの更新

### `MidiFilePluginBlueprint.h` の更新

```diff cpp
...

/**
 * 
 */
UCLASS()
class MIDIFILEPLUGINBLUEPRINTMODULE_API UMidiFilePluginBlueprint : public UBlueprintFunctionLibrary
{
	GENERATED_BODY()

public:
	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin")
	static UMidiFileSequence* CreateMidiFileSequence(UMidiFileObject* MidiFileObject);

	UFUNCTION(BlueprintCallable, Category = "Midi File Plugin", meta = (ExpandEnumAsExecs = "MidiType"))
	static UMidiFilePluginMidiEvent* BranchMidiEvent(UMidiFilePluginMidiEvent* mfp_event, EMidiType& MidiType);

+	UFUNCTION(BlueprintCallable, Category = "Midi File Asset")
+	static void ParseMidiEvent(UMidiFilePluginMidiEvent* mfp_event, int& ch, int& note, int& velocity);
+	
+	UFUNCTION(BlueprintCallable, Category = "Midi File Asset")
+	static void ParseCC(UMidiFilePluginMidiEvent* mfp_event, int& ch, int& no, int& value);

};

```

### `MidiFilePluginBlueprint.cpp` の更新

```diff cpp
...

+ void UMidiFilePluginBlueprint :: ParseMidiEvent(UMidiFilePluginMidiEvent* mfp_event, int& ch, int& note, int& velocity){
+ 
+     if( ! ensureMsgf(mfp_event != nullptr, TEXT("[UMidiFilePluginBlueprint :: ParseMidiEvent] : mfp_event is nullptr")) )
+         return;
+ 
+     const smf :: MidiEvent& midi_event = mfp_event -> event;
+ 
+     ch       = midi_event.getChannel();
+     note     = midi_event.getKeyNumber();
+     velocity = midi_event.getVelocity();
+ 
+     return;
+ 
+ 
+ }
+ 	
+ void UMidiFilePluginBlueprint :: ParseCC(UMidiFilePluginMidiEvent* mfp_event, int& ch, int& no, int& value){
+ 
+     if( ! ensureMsgf(mfp_event != nullptr, TEXT("[UMidiFilePluginBlueprint :: ParseCC] : mfp_event is nullptr")) )
+         return;
+ 
+     const smf :: MidiEvent& midi_event = mfp_event -> event;
+ 
+     ch    = midi_event.getChannel();
+     no    = midi_event.getControllerNumber();
+     value = midi_event.getControllerValue();
+ 
+     return;
+ 
+ 
+ }

```

## デバッグ出力の削除(任意)

以前 `MidiFileSequence.cpp` に追加したデバッグ出力はもう不要になるため、以下のコードを削除しておきます:


```diff cpp
...

-    for(int32 index = 0 ; index < events.Num() ; ++ index){
-        if (GEngine)
-        {
-            FString Msg = FString :: Printf(
-                TEXT("events[%d] : Note message ? %d"), index, events[index] -> event.isNote() // 表示メッセージ
-            );
-            GEngine->AddOnScreenDebugMessage(
-                -1,                        // 表示スロットID（-1で自動）
-                5.0f,                      // 表示時間（秒）
-                FColor::Green,             // テキストの色
-                Msg                        // 表示メッセージ
-            );
-        }
-    }

...
```

## Blueprintでの利用方法

`BranchMidiEvent` ノードの後ろに、以下のようなノードを追加します。

![ParseMidiEventとParseCCを追加](/images/books/ue_midi_file_plugin/23/03.png)

実行すると、ノートオン/オフ、コントロールチェンジイベントが表示されます。

![動作確認](/images/books/ue_midi_file_plugin/23/04.gif)

## ✅ まとめ

このチャプターでは、ノートイベントとコントロールチェンジイベントを扱う `ParseMidiEvent` および `ParseCC` ノードを実装しました。  
これで、再生されたMIDIデータをBlueprint上で扱うことができるようになります。
